<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Upgrading from SUSE OpenStack Cloud Crowbar 8 to SUSE OpenStack Cloud Crowbar 9</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.2" /><style type="text/css">
body { background-image: url('static/images/draft.png');
       background-repeat: no-repeat;
       background-position: top left;
       /* The following properties make the watermark "fixed" on the page. */
       /* I think that's just a bit too distracting for the reader... */
       /* background-attachment: fixed; */
       /* background-position: center center; */
     }</style><link rel="home" href="index.html" title="SUSE OpenStack Cloud Crowbar 9 Documentation" /><link rel="up" href="sec-maintenance.html" title="Chapter 1. Maintenance" /><link rel="prev" href="sec-service-orders.html" title="Service Order on SUSE OpenStack Cloud Start-up or Shutdown" /><link rel="next" href="sec-recover-comp-node-failure.html" title="Recovering from Compute Node Failure" /></head><body onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Upgrading from <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 8 to <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 9</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="sec-service-orders.html">Prev</a> </td><th width="60%" align="center">Chapter 1. Maintenance</th><td width="20%" align="right"> <a accesskey="n" href="sec-recover-comp-node-failure.html">Next</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-upgrade-8-9"></a>Upgrading from <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 8 to <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 9</h2></div></div></div><p>
      Upgrading from <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 8 to <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 9 can be done either via a
      Web interface or from the command line. <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> supports a non-disruptive
      upgrade which provides a fully-functional SUSE <span class="productname">OpenStack</span> Cloud operation during most of
      the upgrade procedure, if your installation meets the requirements at <a class="xref" href="sec-upgrade-8-9.html#il-upgrade-8-9-non-disruptive" title="Non-Disruptive Upgrade Requirements">Non-Disruptive Upgrade Requirements</a>.
    </p><p>
      If the requirements for a non-disruptive upgrade are not met, the
      upgrade procedure will be done in normal mode. When
      live-migration is set up, instances will be migrated to another node
      before the respective Compute Node is updated to ensure continuous
      operation.
    </p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">STONITH and Administration Server</h3><p>
        Make sure that the STONITH mechanism in your cloud does not rely on the
        state of the Administration Server (for example, no SBD devices are located there,
        and IPMI is not using the network connection relying on the
        Administration Server). Otherwise, this may affect the clusters when the Administration Server is
        rebooted during the upgrade procedure.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-upgrade-8-9-requirements"></a>Requirements</h3></div></div></div><p>
        When starting the upgrade process, several checks are performed to
        determine whether the SUSE <span class="productname">OpenStack</span> Cloud is in an upgradeable state and whether a
        non-disruptive update would be supported:
      </p><div class="itemizedlist"><p class="title"><strong>General Upgrade Requirements</strong></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            All nodes need to have the latest <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 8 updates <span class="bold"><strong>and</strong></span> the latest SLES 12 SP3 updates installed. If
            this is not the case, refer to <a class="xref" href="sec-depl-inst-nodes-post.html#sec-depl-inst-nodes-post-updater" title="Deploying Node Updates with the Updater Barclamp">the section called “Deploying Node Updates with the Updater Barclamp”</a> for instructions on how to
            update.
          </p></li><li class="listitem"><p>
            All allocated nodes need to be turned on and have to be in state
            <span class="quote">“<span class="quote">ready</span>”</span>.
          </p></li><li class="listitem"><p>
            All barclamp proposals need to have been successfully deployed. If a
            proposal is in state <span class="quote">“<span class="quote">failed</span>”</span>, the upgrade procedure will
            refuse to start. Fix the issue, or remove the proposal, if necessary.
          </p></li><li class="listitem"><p>
            If the Pacemaker barclamp is deployed, all clusters
            need to be in a healthy state.
          </p></li><li class="listitem"><p> The upgrade will not start when Ceph is deployed via Crowbar. Only
            external Ceph is supported. Documentation for SUSE Enterprise Storage is available at
            <a class="link" href="https://documentation.suse.com/ses/5.5/" target="_top">https://documentation.suse.com/ses/5.5/</a>.
          </p></li><li class="listitem"><p>
            The following repositories need to be available on a server that is
            accessible from the Administration Server. The HA repositories are only needed if you
            have an HA setup. It is recommended to use the same server that also
            hosts the respective repositories of the current version.
          </p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal"><span class="phrase"><span class="phrase">SUSE-OpenStack-Cloud-Crowbar-9</span></span>-Pool</code></td></tr><tr><td><code class="literal"><span class="phrase"><span class="phrase">SUSE-OpenStack-Cloud-Crowbar-9</span></span>-Update</code></td></tr><tr><td><code class="literal">SLES12-SP4-Pool</code></td></tr><tr><td><code class="literal">SLES12-SP4-Update</code></td></tr><tr><td>
              <code class="literal">SLE-HA12-SP4-Pool</code> (for HA setups only)
            </td></tr><tr><td>
              <code class="literal">SLE-HA12-SP4-Update</code> (for HA setups only)
            </td></tr></table><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
              Do not add repositories to the SUSE <span class="productname">OpenStack</span> Cloud repository configuration. This
              needs to be done during the upgrade procedure.
            </p></div></li></ul></div><div class="itemizedlist"><a id="il-upgrade-8-9-non-disruptive"></a><p class="title"><strong>Non-Disruptive Upgrade Requirements</strong></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            All Control Nodes need to be set up highly available.
          </p></li><li class="listitem"><p>
            A non-disruptive upgrade is not supported if the cinder
            has been deployed with the <code class="literal">raw devices</code> or
            <code class="literal">local file</code> back-end. In this case, you have to perform
            a regular upgrade, or change the cinder back-end for a
            non-disruptive upgrade.
          </p></li><li class="listitem"><p>
            A non-disruptive upgrade is prevented if the
            <code class="literal">cinder-volume</code> service is placed on Compute Node. For a
            non-disruptive upgrade, <code class="literal">cinder-volume</code> should either be
            HA-enabled or placed on non-compute nodes.
          </p></li><li class="listitem"><p>
            A non-disruptive upgrade is prevented if <code class="literal">manila-share</code>
            service is placed on a Compute Node. For more information, see <a class="xref" href="sec-depl-ostack-manila.html" title="Deploying manila">the section called “Deploying manila”</a>.
          </p></li><li class="listitem"><p>
            Live-migration support needs to be configured and enabled for the
            Compute Nodes. The amount of free resources (CPU and RAM) on the
            Compute Nodes needs to be sufficient to evacuate the nodes one by one.
          </p></li><li class="listitem"><p>
            In case of a non-disruptive upgrade, glance must be configured as a
            shared storage if the <span class="guimenu">Default Storage
              Store</span> value in the glance is set to <code class="literal">File</code>.
          </p></li><li class="listitem"><p>
            For a non-disruptive upgrade, only KVM-based Compute Nodes with
            the <code class="literal">nova-compute-kvm</code> role are allowed in <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 8.
          </p></li><li class="listitem"><p>
            Non-disruptive upgrade is limited to the following cluster
            configurations:
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                Single cluster that has all supported controller roles on it
              </p></li><li class="listitem"><p>
                Two clusters where one only has
                <code class="systemitem">neutron-network</code> and the other one has the
                rest of the controller roles.
              </p></li><li class="listitem"><p>
                Two clusters where one only has
                <code class="systemitem">neutron-server</code> plus
                <code class="systemitem">neutron-network</code> and the other one has the
                rest of the controller roles.
              </p></li><li class="listitem"><p>
                Two clusters, where one cluster runs the database and RabbitMQ
              </p></li><li class="listitem"><p>
                Three clusters, where one cluster runs database and RabbitMQ,
                another cluster has the controller roles, and the third cluster has
                the <code class="systemitem">neutron-network</code> role.
	      </p></li></ul></div><p>
            If your cluster configuration is not supported by the non-disruptive
            upgrade procedure, you can still perform a normal upgrade.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-upgrade-unsupported-configs"></a>Unsupported configurations</h3></div></div></div><p>
        In SUSE <span class="productname">OpenStack</span> Cloud 9, certain configurations and barclamp combinations
        are no longer supported. See the <a class="link" href="https://www.suse.com/releasenotes/x86_64/SUSE-OPENSTACK-CLOUD/9/" target="_top">SUSE <span class="productname">OpenStack</span> Cloud
        9 release notes</a> for details. The upgrade prechecks fail
        if they detect an unsupported configuration. Below is a list
        configurations that cause failure and possible solutions.
</p><div class="variablelist"><p class="title"><strong>Unsupported Configurations</strong></p><dl class="variablelist"><dt><span class="term">
            aodh deployed
          </span></dt><dd><p>
              The aodh barclamp has been removed in SUSE <span class="productname">OpenStack</span> Cloud 9. Deactivate and delete
              the aodh proposal before continuing the upgrade.
            </p></dd><dt><span class="term">
            ceilometer deployed without monasca
          </span></dt><dd><p>
              As of SUSE <span class="productname">OpenStack</span> Cloud 9, ceilometer has been reduced to the ceilometer agent,
              with monasca being used as a storage back-end. Consequently, a
              standalone ceilometer without monasca present will fail the upgrade
              prechecks. There are two possible solutions.
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	          Deactivate and delete the ceilometer proposal before the upgrade, and
	          re-enable it after the upgrade.
	        </p></li><li class="listitem"><p>
	          Deploy the monasca barclamp before the upgrade.
	        </p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Existing ceilometer Data</h3><p>
		Existing ceilometer data is not migrated to new
		monasca storage. It stays in the MariaDB
		ceilometer database, and it can be accessed directly,
		if needed. The data is also included in the <span class="productname">OpenStack</span>
		database backup created by upgrade process.
	      </p></div></dd><dt><span class="term">
            nova: Xen Compute Nodes present
          </span></dt><dd><p>
              As of SUSE <span class="productname">OpenStack</span> Cloud 9, the Xen hypervisor is no longer supported. On any
              cloud, where Xen based compute nodes are still present, the following
              procedure must be followed before it can be upgraded to SUSE <span class="productname">OpenStack</span> Cloud 9:
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                  Run <span class="command"><strong>nova service-disable</strong></span> for all nova Compute Nodes
                  running the Xen hypervisor. In the Crowbar context, these are the
                  Compute Nodes with the <code class="literal">nova-compute-xen</code> role in the
                  nova barclamp. This prevents any new VMs from being launched on these
                  Compute Nodes. It is safe to leave the Compute Nodes in question in this
                  state for the entire duration of the next step.
                </p></li><li class="listitem"><p>
                  Recreate all nova instances still running on the Xen-based
                  Compute Nodes on non-Xen Compute Nodes or shut them down completely.
                </p></li><li class="listitem"><p>
                  With no other instances on the Xen-based Compute Nodes, remove the nova
                  barclamp's <code class="literal">nova-compute-xen</code> role from these nodes and
                  re-apply the nova barclamp. You may optionally assign a different
                  <code class="literal">nova-compute</code> role, such as
                  <code class="literal">nova-compute-kvm</code>, to configure them as Compute Nodes for
                  one of the remaining hypervisors.
                </p></li></ul></div></dd><dt><span class="term">
            trove deployed
          </span></dt><dd><p>
              The trove barclamp has been removed in SUSE <span class="productname">OpenStack</span> Cloud 9. Deactivate and delete
              the trove proposal before continuing the upgrade.
            </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-upgrade-web-ui"></a>Upgrading Using the Web Interface</h3></div></div></div><p>
        The Web interface features a wizard that guides you through the upgrade
        procedure.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Canceling the Upgrade</h3><p>
          You can cancel the upgrade process by clicking <span class="guimenu">Cancel
            Upgrade</span>. The upgrade operation can only be canceled
          before the Administration Server upgrade is started. When the upgrade has been
          canceled, the nodes return to the ready state. However, any user
          modifications must be undone manually. This includes reverting repository
          configuration.
        </p></div><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
            To start the upgrade procedure, open the Crowbar Web interface on the Administration Server and choose <span class="guimenu">Utilities</span>+<span class="guimenu">Upgrade</span>. Alternatively, point the browser directly to the upgrade
            wizard on the Administration Server, for example
            <code class="literal">http://192.168.124.10/upgrade/</code>.
          </p></li><li class="step"><p>
            On the first screen of the Web interface you will run preliminary checks, get
            information about the upgrade mode and start the upgrade process.
          </p><div class="informalfigure"><div class="mediaobject"><img src="images/depl_upgrade_prepare.png" /></div></div></li><li class="step"><p>
            Perform the preliminary checks to determine whether the upgrade
            requirements are met by clicking <span class="guimenu">Check</span> in
            <code class="literal">Preliminary Checks</code>.
          </p><p>
            The Web interface displays the progress of the checks. You will see green, yellow or
            red indicator next to each check. Yellow means the upgrade can only be
            performed in the normal mode. Red indicates an error, which means that
            you need to fix the problem and run the <span class="guimenu">Check</span> again.
          </p></li><li class="step"><p>
            When all checks in the previous step have passed, <code class="literal">Upgrade
              Mode</code> shows the result of the upgrade analysis. It will indicate
            whether the upgrade procedure will continue in non-disruptive or in
            normal mode.
          </p></li><li class="step"><p>
            To start the upgrade process, click <span class="guimenu">Begin Upgrade</span>.
          </p></li><li class="step"><p>
            While the upgrade of the Administration Server is prepared, the upgrade wizard
            prompts you to <span class="guimenu">Download the Backup of the
              Administration Server</span>. When the backup is done, move it to a safe place. If
            something goes wrong during the upgrade procedure of the Administration Server, you
            can restore the original state from this backup using the
            <span class="command"><strong>crowbarctl backup restore
              <em class="replaceable"><code>NAME</code></em></strong></span> command.
          </p></li><li class="step"><p>
            Check that the repositories required for upgrading the Administration Server are
            available and updated. To do this, click the <span class="guimenu">Check</span>
            button. If the checks fail, add the software repositories as described in
            <a class="xref" href="cha-depl-repo-conf.html" title="Chapter 5. Software Repository Setup">Chapter 5, <em>Software Repository Setup</em></a>. Run the
            checks again, and click <span class="guimenu">Next</span>.
          </p><div class="informalfigure"><div class="mediaobject"><img src="images/depl_upgrade_repocheck-admin.png" /></div></div></li><li class="step"><p>
            Click <span class="guimenu">Upgrade Administration Server</span> to upgrade and
            reboot the admin node. Note that this operation may take a while. When
            the Administration Server has been updated, click <span class="guimenu">Next</span>.
          </p><div class="informalfigure"><div class="mediaobject"><img src="images/depl_upgrade_admin.png" /></div></div></li><li class="step"><p>
            Check that the repositories required for upgrading all nodes are
            available and updated.  To do this click the <span class="guimenu">Check</span>
            button. If the check fails, add the software repositories as described in
            <a class="xref" href="cha-depl-repo-conf.html" title="Chapter 5. Software Repository Setup">Chapter 5, <em>Software Repository Setup</em></a>. Run the
            checks again, and click <span class="guimenu">Next</span>.
          </p><div class="informalfigure"><div class="mediaobject"><img src="images/depl_upgrade_repocheck-nodes.png" /></div></div></li><li class="step"><p>
            Next, you need to stop <span class="productname">OpenStack</span> services. This makes the <span class="productname">OpenStack</span> API
            unavailable until the upgrade of control plane is
            completed. When you are ready, click <span class="guimenu">Stop
              Services</span>. Wait until the services are stopped and click
            <span class="guimenu">Next</span>.
          </p></li><li class="step"><p>
            Before upgrading the nodes, the wizard prompts you to <span class="guimenu">Back up
              OpenStack Database</span>. The MariaDB database backup will be
            stored on the Administration Server. It can be used to restore the database in case
            something goes wrong during the upgrade. To back up the database, click
            <span class="guimenu">Create Backup</span>. When the backup operation is
            finished, click <span class="guimenu">Next</span>.
          </p></li><li class="step"><p>
            If you prefer to upgrade the controller nodes and postpone upgrading
            Compute Nodes, disable the <span class="guimenu">Upgrade Compute Nodes</span>
            option. In this case, you can use the <span class="guimenu">Go to Dashboard</span>
            button to switch to the Crowbar Web interface to check the current configuration
            and make changes, as long as they do not affect the Compute Nodes. If you
            choose to postpone upgrading Compute Nodes, all <span class="productname">OpenStack</span> services remain up
            and running.
          </p><div class="informalfigure"><div class="mediaobject"><img src="images/depl_compnode_postponed.png" /></div></div></li><li class="step"><p>
            When the upgrade is completed, press <span class="guimenu">Finish</span> to
            return to the Dashboard.
          </p><div class="informalfigure"><div class="mediaobject"><img src="images/depl_upgrade_finished.png" /></div></div></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Dealing with Errors</h3><p>
          If an error occurs during the upgrade process, the wizard displays a
          message with a description of the error and a possible solution. After
          fixing the error, re-run the step where the error occurred.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-upgrade-command-line"></a>Upgrading from the Command Line</h3></div></div></div><p>
        The upgrade procedure on the command line is performed by using the program
        <span class="command"><strong>crowbarctl</strong></span>. For general help, run <span class="command"><strong>crowbarctl
          help</strong></span>. To get help on a certain subcommand, run
        <span class="command"><strong>crowbarctl <em class="replaceable"><code>COMMAND</code></em> help</strong></span>.
      </p><p>
        To review the process of the upgrade procedure, you may call
        <span class="command"><strong>crowbarctl upgrade status</strong></span> at any time. Steps may have
        three states: <code class="literal">pending</code>, <code class="literal">running</code>, and
        <code class="literal">passed</code>.
      </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
            To start the upgrade procedure from the command line, log in to the
            Administration Server as <code class="systemitem">root</code>.
          </p></li><li class="step"><p>
            Perform the preliminary checks to determine whether the upgrade
            requirements are met:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade prechecks</pre><p>
            The command's result is shown in a table. Make sure the column
            <span class="guimenu">Errors</span> does not contain any entries. If there are
            errors, fix them and restart the <span class="command"><strong>precheck</strong></span> command
            afterwards. You cannot proceed until the mandatory checks have passed.
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade prechecks
            +-------------------------------+--------+----------+--------+------+
            | Check ID                      | Passed | Required | Errors | Help |
            +-------------------------------+--------+----------+--------+------+
            | network_checks                | true   | true     |        |      |
            | cloud_healthy                 | true   | true     |        |      |
            | maintenance_updates_installed | true   | true     |        |      |
            | compute_status                | true   | false    |        |      |
            | ha_configured                 | true   | false    |        |      |
            | clusters_healthy              | true   | true     |        |      |
            +-------------------------------+--------+----------+--------+------+</pre><p>
            Depending on the outcome of the checks, it is automatically decided
            whether the upgrade procedure will continue in non-disruptive or in
            normal mode. For the non-disruptive mode, all the checks must pass,
            including those that are not marked in the table as required.
          </p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Forcing Normal Mode Upgrade</h3><p>
              The non-disruptive update will take longer than an upgrade in normal
              mode, because it performs certain tasks sequentially which are done
              in parallel during the normal upgrade. Live-migrating guests to
              other Compute Nodes during the non-disruptive
              upgrade takes additional time.
            </p><p>
              Therefore, if a non-disruptive upgrade is not a requirement for you, you
              may want to switch to the normal upgrade mode, even if your setup
              supports the non-disruptive method. To force the normal upgrade mode,
              run:
            </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade mode normal</pre><p>
              To query the current upgrade mode run:
            </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade mode</pre><p>
              To switch back to the non-disruptive mode run:
            </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade mode non_disruptive</pre><p>
              It is possible to call this command at any time during the upgrade
              process until the <code class="literal">services</code> step is started. After
              that point the upgrade mode can no longer be changed.
            </p></div></li><li class="step"><p>
            Prepare the nodes by transitioning them into the <span class="quote">“<span class="quote">upgrade</span>”</span>
            state and stopping the chef daemon:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade prepare</pre><p>
            Depending of the size of your SUSE <span class="productname">OpenStack</span> Cloud deployment, this step may take
            some time. Use the command <span class="command"><strong>crowbarctl upgrade status</strong></span>
            to monitor the status of the process named
            <code class="literal">steps.prepare.status</code>. It needs to be in state
            <code class="literal">passed</code> before you proceed:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade status
            +--------------------------------+----------------+
            | Status                         | Value          |
            +--------------------------------+----------------+
            | current_step                   | backup_crowbar |
            | current_substep                |                |
            | current_substep_status         |                |
            | current_nodes                  |                |
            | current_node_action            |                |
            | remaining_nodes                |                |
            | upgraded_nodes                 |                |
            | crowbar_backup                 |                |
            | openstack_backup               |                |
            | suggested_upgrade_mode         | non_disruptive |
            | selected_upgrade_mode          |                |
            | compute_nodes_postponed        | false          |
            | steps.prechecks.status         | passed         |
            | steps.prepare.status           | passed         |
            | steps.backup_crowbar.status    | pending        |
            | steps.repocheck_crowbar.status | pending        |
            | steps.admin.status             | pending        |
            | steps.repocheck_nodes.status   | pending        |
            | steps.services.status          | pending        |
            | steps.backup_openstack.status  | pending        |
            | steps.nodes.status             | pending        |
            +--------------------------------+----------------+</pre></li><li class="step"><p>
            Create a backup of the existing Administration Server installation. In case something
            goes wrong during the upgrade procedure of the Administration Server you can restore
            the original state from this backup with the command <span class="command"><strong>crowbarctl
              backup restore <em class="replaceable"><code>NAME</code></em></strong></span>
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade backup crowbar</pre><p>
            To list all existing backups including the one you have just created, run
            the following command:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl backup list
            +----------------------------+--------------------------+--------+---------+
            | Name                       | Created                  | Size   | Version |
            +----------------------------+--------------------------+--------+---------+
            | crowbar_upgrade_1534864741 | 2018-08-21T15:19:03.138Z | 219 KB | 4.0     |
            +----------------------------+--------------------------+--------+---------+</pre></li><li class="step"><p>
            This step prepares the upgrade of the Administration Server by checking the
            availability of the update and pool repositories for <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span>
            9 and SUSE Linux Enterprise Server 12 SP4. Run the following command:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade repocheck crowbar
            +----------------------------------------+------------------+-----------+
            | Repository                             | Status           | Type      |
            +----------------------------------------+------------------+-----------+
            | SLES12-SP4-Pool                        | x86_64 (missing) | os        |
            | SLES12-SP4-Updates                     | x86_64 (missing) | os        |
            | SUSE-OpenStack-Cloud-Crowbar-9-Pool    | available        | openstack |
            | SUSE-OpenStack-Cloud-Crowbar-9-Updates | available        | openstack |
            +----------------------------------------+------------------+-----------+</pre><p>
            Two of the required repositories are reported as missing, because they have
            not yet been added to the Crowbar configuration. To add them to the
            Administration Server proceed as follows.
          </p><p>
            Note that this step is for setting up the repositories for the Administration Server,
            not for the nodes in SUSE <span class="productname">OpenStack</span> Cloud (this will be done in a subsequent step).
          </p><ol type="a" class="substeps"><li class="step"><p>
                Start <span class="command"><strong>yast repositories</strong></span> and proceed with
                <span class="guimenu">Continue</span>. Replace the repositories
                <code class="literal">SLES12-SP3-Pool</code> and
                <code class="literal">SLES12-SP3-Updates</code> with the respective SP4
                repositories.
              </p><p>
                If you prefer to use zypper over YaST, you may alternatively make the
                change using <span class="command"><strong>zypper mr</strong></span>.
              </p></li><li class="step"><p>
                Next, replace the <code class="literal">SUSE-OpenStack-Cloud-Crowbar-8</code>
                update and pool repositories with the respective <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 9 versions.
              </p></li><li class="step"><p>
                Check for other (custom) repositories. All SLES SP3 repositories need
                to be replaced with the respective SLES SP4 version. In case no SP3
                version exists, disable the repository—the respective packages
                from that repository will be deleted during the upgrade.
              </p></li></ol><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Administration Server with external SMT</h3><p>
              If the Administration Server is configured with external SMT, the system
              repositories configuration is managed by the system utilities. In this
              case, skip the above substeps and run the <span class="command"><strong>zypper migration
                --download-only</strong></span> command.
            </p></div><p>
            Once the repository configuration on the Administration Server has been updated, run
            the command to check the repositories again. If the configuration is
            correct, the result should look like the following:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade repocheck crowbar
            +----------------------------------------+-----------+-----------+
            | Repository                             | Status    | Type      |
            +----------------------------------------+-----------+-----------+
            | SLES12-SP4-Pool                        | available | os        |
            | SLES12-SP4-Updates                     | available | os        |
            | SUSE-OpenStack-Cloud-Crowbar-9-Pool    | available | openstack |
            | SUSE-OpenStack-Cloud-Crowbar-9-Updates | available | openstack |
            +----------------------------------------+-----------+-----------+</pre></li><li class="step"><p>
            Now that the repositories are available, the Administration Server itself will be
            upgraded. The update will run in the background using <span class="command"><strong>zypper
              dup</strong></span>. Once all packages have been upgraded, the Administration Server will
            be rebooted and you will be logged out. To start the upgrade run:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade admin</pre></li><li class="step"><p>
            After the Administration Server has been successfully updated, the Control Nodes and
            Compute Nodes will be upgraded. At first the availability of the
            repositories used to provide packages for the SUSE <span class="productname">OpenStack</span> Cloud nodes is tested.
          </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Correct Metadata in the PTF Repository</h3><p>
              When adding new repositories to the nodes, make sure that the new PTF
              repository also contains correct metadata (even if it is empty). To do
              this, run the <span class="command"><strong>createrepo-cloud-ptf</strong></span> command.
            </p></div><p>
            Note that the configuration for these repositories differs from the one
            for the Administration Server that was already done in a previous step. In this step
            the repository locations are made available to Crowbar rather than to
            libzypp on the Administration Server. To check the repository configuration run the
            following command:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade repocheck nodes
            +----------------------------------------+-------------------------------------+-----------+
            | Repository                             | Status                              | Type      |
            +----------------------------------------+-------------------------------------+-----------+
            | SLE12-SP4-HA-Pool                      | missing (x86_64), inactive (x86_64) | ha        |
            | SLE12-SP4-HA-Updates                   | missing (x86_64), inactive (x86_64) | ha        |
            | SLE12-SP4-HA-Updates-test              | missing (x86_64), inactive (x86_64) | ha        |
            | SLES12-SP4-Pool                        | missing (x86_64), inactive (x86_64) | os        |
            | SLES12-SP4-Updates                     | missing (x86_64), inactive (x86_64) | os        |
            | SLES12-SP4-Updates-test                | missing (x86_64), inactive (x86_64) | os        |
            | SUSE-OpenStack-Cloud-Crowbar-9-Pool    | missing (x86_64), inactive (x86_64) | openstack |
            | SUSE-OpenStack-Cloud-Crowbar-9-Updates | missing (x86_64), inactive (x86_64) | openstack |
            +----------------------------------------+-------------------------------------+-----------+</pre><p>
            To update the locations for the listed repositories, start <span class="command"><strong>yast
              crowbar</strong></span> and proceed as described in <a class="xref" href="sec-depl-adm-inst-crowbar-repos.html" title="Repositories">the section called “<span class="guimenu">Repositories</span>”</a>.
          </p><p>
            Once the repository configuration for Crowbar has been updated, run the
            command to check the repositories again to determine, whether the current
            configuration is correct.
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade repocheck nodes
            +----------------------------------------+-----------+-----------+
            | Repository                             | Status    | Type      |
            +----------------------------------------+-----------+-----------+
            | SLE12-SP4-HA-Pool                      | available | ha        |
            | SLE12-SP4-HA-Updates                   | available | ha        |
            | SLES12-SP4-Pool                        | available | os        |
            | SLES12-SP4-Updates                     | available | os        |
            | SUSE-OpenStack-Cloud-Crowbar-9-Pool    | available | openstack |
            | SUSE-OpenStack-Cloud-Crowbar-9-Updates | available | openstack |
            +----------------------------------------+-----------+-----------+</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Shut Down Running instances in Normal Mode</h3><p>
              If the upgrade is done in the normal mode, you need to shut down or suspend
              all running instances before performing the next step.
            </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Product Media Repository Copies</h3><p>
              To PXE boot new nodes, an additional SUSE Linux Enterprise Server 12 SP4 repository—a copy
              of the installation system— is required. Although not required
              during the upgrade procedure, it is recommended to set up this directory
              now. Refer to <a class="xref" href="cha-depl-repo-conf.html#sec-depl-adm-conf-repos-product" title="Copying the Product Media Repositories">the section called “Copying the Product Media Repositories”</a> for
              details. If you had also copied the <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span> 8 installation media
              (optional), you may also want to provide the <span class="phrase"><span class="phrase">SUSE <span class="productname">OpenStack</span> Cloud Crowbar</span></span>
              9 the same way.
            </p><p>
              Once the upgrade procedure has been successfully finished, you may
              delete the previous copies of the installation media in
              <code class="filename">/srv/tftpboot/suse-12.4/x86_64/install</code> and
              <code class="filename">/srv/tftpboot/suse-12.4/x86_64/repos/Cloud</code>.
            </p></div></li><li class="step"><p>
            To ensure the status of the nodes does not change during the upgrade
            process, the majority of the <span class="productname">OpenStack</span> services will be stopped on the
            nodes. As a result, the <span class="productname">OpenStack</span> API will no longer be accessible. In
            case of the non-disruptive mode, the instances will continue to run and
            stay accessible. Run the following command:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade services</pre><p>
            This step takes a while to finish. Monitor the process by running
            <span class="command"><strong>crowbarctl upgrade status</strong></span>. Do not proceed before
            <code class="literal">steps.services.status</code> is set to
            <code class="literal">passed</code>.
          </p></li><li class="step"><p>
            The last step before upgrading the nodes is to make a backup of the
            <span class="productname">OpenStack</span> database. The database dump will be stored on the
            Administration Server and can be used to restore the database in case something goes
            wrong during the upgrade.
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade backup openstack</pre><p>
            To find the location of the database dump, run the <span class="command"><strong>crowbarctl
              upgrade status</strong></span>.
          </p></li><li class="step"><p>
            The final step of the upgrade procedure is upgrading the
            nodes.  To start the process, enter:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade nodes all</pre><p>
            The upgrade process runs in the background and can be queried with
            <span class="command"><strong>crowbarctl upgrade status</strong></span>. Depending on the size of
            your SUSE <span class="productname">OpenStack</span> Cloud it may take several hours, especially when performing a
            non-disruptive update. In that case, the Compute Nodes are updated
            one-by-one after instances have been live-migrated to other nodes.
          </p><p>
            Instead of upgrading all nodes you may also upgrade
            the Control Nodes first and individual Compute Nodes afterwards. Refer to
            <span class="command"><strong>crowbarctl upgrade nodes --help</strong></span> for details. If you
            choose this approach, you can use the <span class="command"><strong>crowbarctl upgrade
              status</strong></span> command to monitor the upgrade process. The output of
            this command contains the following entries:
          </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
                current_node_action
              </span></dt><dd><p>
                  The current action applied to the node.
                </p></dd><dt><span class="term">
                current_substep
              </span></dt><dd><p>
                  Shows the current substep of the node upgrade step. For example,
                  for the <span class="command"><strong>crowbarctl upgrade nodes controllers</strong></span>,
                  the <code class="literal">current_substep</code> entry displays the
                  <code class="literal">controller_nodes</code> status when upgrading controllers.
                </p></dd></dl></div><p>
            After the controllers have been upgraded, the
            <code class="literal">steps.nodes.status</code> entry in the output displays the
            <code class="literal">running</code> status. Check then the status of the
            <code class="literal">current_substep_status</code> entry. If it displays
            <code class="literal">finished</code>, you can move to the next step of upgrading
            the Compute Nodes.
          </p><p>
            <span class="bold"><strong>Postponing the Upgrade</strong></span>
          </p><p>
            It is possible to stop the upgrade of compute nodes and postpone their
            upgrade with the command:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade nodes postpone</pre><p>
            After the upgrade of compute nodes is postponed, you can go to Crowbar
            Web interface, check the configuration. You can also apply some changes, provided
            they do not affect the Compute Nodes. During the postponed upgrade, all
            <span class="productname">OpenStack</span> services should be up and running.
          </p><p>
            To resume the upgrade, issue the command:
          </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade nodes resume</pre><p>
            Finish the upgrade with either <span class="command"><strong>crowbarctl upgrade nodes
              all</strong></span> or upgrade nodes one node by one with <span class="command"><strong>crowbarctl
              upgrade nodes <em class="replaceable"><code>NODE_NAME</code></em></strong></span>.
          </p><p>
            When upgrading individual Compute Nodes using the <span class="command"><strong>crowbarctl
              upgrade nodes</strong></span> <em class="replaceable"><code>NODE_NAME</code></em> command, the
            <code class="literal">current_substep_status</code> entry changes to
            <code class="literal">node_finished</code> when the upgrade of a single node is
            done. After all nodes have been upgraded, the
            <code class="literal">current_substep_status</code> entry displays <code class="literal">finished</code>.
          </p></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Dealing with Errors</h3><p>
          If an error occurs during the upgrade process, the output of the
          <span class="command"><strong>crowbarctl upgrade status</strong></span> provides a detailed
          description of the failure. In most cases, both the output and the error
          message offer enough information for fixing the issue. When the problem has
          been solved, run the previously-issued upgrade command to resume the
          upgrade process.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sec-depl-maintenance-parallel-upgrade-cmdl"></a>Simultaneous Upgrade of Multiple Nodes</h4></div></div></div><p>
          It is possible to select more Compute Nodes for selective upgrade instead of
          just one. Upgrading multiple nodes simultaneously significantly reduces the
          time required for the upgrade.
        </p><p>
          To upgrade multiple nodes simultaneously, use the following command:
        </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade nodes <em class="replaceable"><code>NODE_NAME_1</code></em>,<em class="replaceable"><code>NODE_NAME_2</code></em>,<em class="replaceable"><code>NODE_NAME_3</code></em></pre><p>
          Node names can be separated by comma, semicolon, or space. When using
          space as separator, put the part containing node names in quotes.
        </p><p>
          Use the following command to find the names of the nodes that haven't been upgraded:
        </p><pre class="screen"><code class="prompt">root # </code>crowbarctl upgrade status nodes</pre><p>
          Since the simultaneous upgrade is intended to be non-disruptive, all
          Compute Nodes targeted for a simultaneous upgrade must be cleared of any
          running instances.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
            You can check what instances are running on a specific
            node using the following command:
          </p><pre class="screen"><code class="prompt">tux &gt; </code>nova list --all-tenants --host <em class="replaceable"><code>NODE_NAME</code></em></pre></div><p>
          This means that it is not possible to pick an arbitrary number of
          Compute Nodes for the simultaneous upgrade operation: you have to make sure
          that it is possible to live-migrate every instance away from the batch of
          nodes that are supposed to be upgraded in parallel. In case of high load
          on all Compute Nodes, it might not be possible to upgrade more than one node
          at a time. Therefore, it is recommended to perform the following steps for
          each node targeted for the simultaneous upgrade prior to running the
          <span class="command"><strong>crowbarctl upgrade nodes</strong></span> command.
        </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
              Disable the Compute Node so it's not used as a target during
              live-evacuation of any other node:
            </p><pre class="screen"><code class="prompt">tux &gt; </code>openstack compute service set --disable <em class="replaceable"><code>"NODE_NAME"</code></em> nova-compute</pre></li><li class="step"><p>
              Evacuate all running instances from the node:
            </p><pre class="screen"><code class="prompt">tux &gt; </code>nova host-evacuate-live <em class="replaceable"><code>"NODE_NAME"</code></em></pre></li></ol></div><p>
          After completing these steps, you can perform a simultaneous upgrade of
          the selected nodes.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-depl-maintenance-upgrade-troubleshooting"></a>Troubleshooting Upgrade Issues</h3></div></div></div><div class="qandaset"><a id="id13639"></a><dl><dt>1. <a href="sec-upgrade-8-9.html#id13640">
              Upgrade of the admin server has failed.
            </a></dt><dt>2. <a href="sec-upgrade-8-9.html#id13648">
              An upgrade step repeatedly fails due to timeout.
            </a></dt><dt>3. <a href="sec-upgrade-8-9.html#live-migration-failed">
              Node upgrade has failed during live migration.
            </a></dt><dt>4. <a href="sec-upgrade-8-9.html#id13699">
              Node has failed during OS upgrade.
            </a></dt><dt>5. <a href="sec-upgrade-8-9.html#id13708">
              Node does not come up after reboot.
            </a></dt><dt>6. <a href="sec-upgrade-8-9.html#id13713">
              N number of nodes were provided to compute upgrade using
              crowbarctl upgrade nodes node_1,node_2,...,node_N,
              but less then N were actually upgraded.
            </a></dt><dt>7. <a href="sec-upgrade-8-9.html#id13720">
              Node has failed at the initial chef client run stage.
            </a></dt><dt>8. <a href="sec-upgrade-8-9.html#id13726">
              I need to change OpenStack configuration during the upgrade but I cannot access Crowbar.
            </a></dt><dt>9. <a href="sec-upgrade-8-9.html#id13734">
              Failure occurred when evacuating routers.
            </a></dt><dt>10. <a href="sec-upgrade-8-9.html#id13747">
              Some non-controller nodes were upgraded after performing crowbarctl upgrade nodes
                controllers.
            </a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%" /><col /></colgroup><tbody><tr class="question"><td align="left" valign="top"><a id="id13640"></a><a id="id13641"></a><p><strong>1.</strong></p></td><td align="left" valign="top"><p>
              Upgrade of the admin server has failed.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              Check for empty, broken, and not signed repositories in the Administration Server
              upgrade log file <code class="filename">/var/log/crowbar/admin-server-upgrade.log</code>. Fix the
              repository setup. Upgrade then remaining packages manually to SUSE Linux Enterprise Server 12 SP4
              and SUSE <span class="productname">OpenStack</span> Cloud 9 using the command <span class="command"><strong>zypper dup</strong></span>. Reboot the Administration Server.
            </p></td></tr><tr class="question"><td align="left" valign="top"><a id="id13648"></a><a id="id13649"></a><p><strong>2.</strong></p></td><td align="left" valign="top"><p>
              An upgrade step repeatedly fails due to timeout.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              Timeouts for most upgrade operations can be adjusted in the
              <code class="filename">/etc/crowbar/upgrade_timeouts.yml</code> file. If the
              file doesn't exist, use the following template, and modify it to your needs:
            </p><pre class="screen">
              :prepare_repositories: 120
              :pre_upgrade: 300
              :upgrade_os: 1500
              :post_upgrade: 600
              :shutdown_services: 600
              :shutdown_remaining_services: 600
              :evacuate_host: 300
              :chef_upgraded: 1200
              :router_migration: 600
              :lbaas_evacuation: 600
              :set_network_agents_state: 300
              :delete_pacemaker_resources: 600
              :delete_cinder_services: 300
              :delete_nova_services: 300
              :wait_until_compute_started: 60
              :reload_nova_services: 120
              :online_migrations: 1800
            </pre><p>
              The following entries may require higher values (all values are
              specified in seconds):
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                  <code class="literal">upgrade_os</code> Time allowed for upgrading all packages of one node.
                </p></li><li class="listitem"><p>
                  <code class="literal">chef_upgraded</code> Time allowed for initial
                  <code class="literal">crowbar_join</code> and <code class="literal">chef-client</code>
                  run on a node that has been upgraded and rebooted.
                </p></li><li class="listitem"><p>
                  <code class="literal">evacuate_host</code> Time allowed for live migrate all VMs from a host.
                </p></li></ul></div></td></tr><tr class="question"><td align="left" valign="top"><a id="live-migration-failed"></a><a id="id13669"></a><p><strong>3.</strong></p></td><td align="left" valign="top"><p>
              Node upgrade has failed during live migration.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              The problem may occur when it is not possible to live migrate certain
              VMs anywhere. It may be necessary to shut down or suspend other VMs to
              make room for migration. Note that the Bash shell script that starts
              the live migration for the Compute Node is executed from the
              Control Node. An error message generated by the <span class="command"><strong>crowbarctl
                upgrade status</strong></span> command contains the exact names of both
              nodes. Check the <code class="filename">/var/log/crowbar/node-upgrade.log</code>
              file on the Control Node for the information that can help you with
              troubleshooting. You might also need to check <span class="productname">OpenStack</span> logs in
              <code class="filename">/var/log/nova</code> on the Compute Node as well as on the
              Control Nodes.
            </p><p>
              It is possible that live-migration of a certain VM takes too long. This
              can happen if instances are very large or network connection between
              compute hosts is slow or overloaded. If this case, try to raise the
              global timeout in
              <code class="filename">/etc/crowbar/upgrade_timeouts.yml</code>.
            </p><p>
              We recommend to perform the live migration manually first. After it is
              completed successfully, call the <span class="command"><strong>crowbarctl upgrade</strong></span>
              command again.
            </p><p>
              The following commands can be helpful for analyzing issues with live migrations:
            </p><pre class="screen">
              nova server-migration-list
              nova server-migration-show
              nova instance-action-list
              nova instance-action
            </pre><p>
              Note that these commands require <span class="productname">OpenStack</span> administrator privileges.
            </p><p>
              The following log files may contain useful information:
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                  <code class="filename">/var/log/nova/nova-compute</code> on the Compute Nodes
                  that the migration is performed from and to.
                </p></li><li class="listitem"><p>
                  <code class="filename">/var/log/nova/*.log</code> (especially log files for the
                  conductor, scheduler and placement services) on the Control Nodes.
                </p></li></ul></div><p>
              It can happen that active instances and instances with heavy
              loads cannot be live migrated in a reasonable time. In that case, you
              can abort a running live-migration operation using the <span class="command"><strong>nova
                live-migration-abort <em class="replaceable"><code>MIGRATION-ID</code></em></strong></span>
              command. You can then perform the upgrade of the specific node at a
              later time.
            </p><p>
              Alternatively, it is possible to force the completion of
              the live migration by using the <span class="command"><strong>nova
                live-migration-force-complete
                <em class="replaceable"><code>MIGRATION-ID</code></em></strong></span> command. However,
              this might pause the instances for a prolonged period of time and have
              a negative impact on the workload running inside the instance.
            </p></td></tr><tr class="question"><td align="left" valign="top"><a id="id13699"></a><a id="id13700"></a><p><strong>4.</strong></p></td><td align="left" valign="top"><p>
              Node has failed during OS upgrade.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              Possible reasons include an incorrect repository setup or package
              conflicts. Check the <code class="filename">/var/log/crowbar/node-upgrade.log</code> log file on the
              affected node. Check the repositories on node using the <span class="command"><strong>zypper
                lr</strong></span> command. Make sure the required repositories are
              available. To test the setup, install a package manually or run the
              <span class="command"><strong>zypper dup</strong></span> command (this command is executed by the
              upgrade script). Fix the repository setup and run the failed upgrade
              step again. If custom package versions or version locks are in place,
              make sure that they don't interfere with the <span class="command"><strong>zypper dup</strong></span> command.
            </p></td></tr><tr class="question"><td align="left" valign="top"><a id="id13708"></a><a id="id13709"></a><p><strong>5.</strong></p></td><td align="left" valign="top"><p>
              Node does not come up after reboot.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              In some cases, a node can take too long to reboot causing a timeout. We
              recommend to check the node manually, make sure it is online, and repeat the step.
            </p></td></tr><tr class="question"><td align="left" valign="top"><a id="id13713"></a><a id="id13714"></a><p><strong>6.</strong></p></td><td align="left" valign="top"><p>
              N number of nodes were provided to compute upgrade using
              <span class="command"><strong>crowbarctl upgrade nodes node_1,node_2,...,node_N</strong></span>,
              but less then N were actually upgraded.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              If the live migration cannot be performed for certain nodes due to a timeout,
              Crowbar upgrades only the nodes that it was able to
              live-evacuate in the specified time. Because some nodes have been upgraded, it is possible that
              more resources will be available for live-migration when you try to run this
              step again. See also <a class="xref" href="sec-upgrade-8-9.html#live-migration-failed" title="3.">Q: 3</a>.
            </p></td></tr><tr class="question"><td align="left" valign="top"><a id="id13720"></a><a id="id13721"></a><p><strong>7.</strong></p></td><td align="left" valign="top"><p>
              Node has failed at the initial chef client run stage.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              An unsupported entry in the configuration file may prevent a service
              from starting. This causes the node to fail at the initial
              chef client run stage. Checking the
              <code class="filename">/var/log/crowbar/crowbar_join/chef.*</code> log files on
              the node is a good starting point.
            </p></td></tr><tr class="question"><td align="left" valign="top"><a id="id13726"></a><a id="id13727"></a><p><strong>8.</strong></p></td><td align="left" valign="top"><p>
              I need to change <span class="productname">OpenStack</span> configuration during the upgrade but I cannot access Crowbar.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              Crowbar Web interface is accessible only when an upgrade is completed or
              when it is postponed. Postponing the upgrade can be done only after
              upgrading all Control Nodes using the <span class="command"><strong>crowbarctl upgrade nodes
                postpone</strong></span> command. You can then access Crowbar and
              save your modifications. Before you can continue with the upgrade of
              rest of the nodes, resume the upgrade using the <span class="command"><strong>crowbarctl
                upgrade nodes resume</strong></span> command.
            </p></td></tr><tr class="question"><td align="left" valign="top"><a id="id13734"></a><a id="id13735"></a><p><strong>9.</strong></p></td><td align="left" valign="top"><p>
              Failure occurred when evacuating routers.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              Check the <code class="filename">/var/log/crowbar/node-upgrade.log</code> file on
              the node that performs the router evacuation (it should be mentioned in
              the error message). The ID of the router that failed to migrate (or the
              affected network port) is logged to
              <code class="filename">/var/log/crowbar/node-upgrade.log</code>. Use the
              <span class="productname">OpenStack</span> CLI tools to check the state of the affected router and
              its ports. Fix manually, if necessary. This can be done by bringing the
              router or port up and down again. The following
              commands can be useful for solving the issue:
            </p><pre class="screen">
              openstack router show <em class="replaceable"><code>ID</code></em>
              openstack port list --router <em class="replaceable"><code>ROUTER-ID</code></em>
              openstack port show <em class="replaceable"><code>PORT-ID</code></em>
              openstack port set
            </pre><p>
              Resume the upgrade by running the failed upgrade step
              again to continue with the router migration.
            </p></td></tr><tr class="question"><td align="left" valign="top"><a id="id13747"></a><a id="id13748"></a><p><strong>10.</strong></p></td><td align="left" valign="top"><p>
              Some non-controller nodes were upgraded after performing <span class="command"><strong>crowbarctl upgrade nodes
                controllers</strong></span>.
            </p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>
              In the current upgrade implementation, <span class="productname">OpenStack</span> nodes are divided
              into Compute Nodes and other nodes. The <span class="command"><strong>crowbarctl upgrade nodes
                controllers</strong></span> command starts the upgrade of all the nodes that
              do not host compute services. This includes the controllers.
            </p></td></tr></tbody></table></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sec-service-orders.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="sec-maintenance.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="sec-recover-comp-node-failure.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Service Order on SUSE <span class="productname">OpenStack</span> Cloud Start-up or Shutdown </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Recovering from Compute Node Failure</td></tr></table></div></body></html>